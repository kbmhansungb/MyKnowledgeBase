<<<<<<< HEAD
---
tags:
  - Unity
  - ImageTracking
  - ComputerVision
  - OpenCV
  - OpenCVForUnity
---
# Unity에서 OpenCV For Unity를 이용하여 이미지 트래킹
앱 설치 없이 웹으로 접속하여 이미지 트래킹 기능을 제공하기 위해 이미지 트래킹을 구현하는 예시입니다. 마커를 인식하고 Homography를 이용하여 정확한 위치와 방향을 계산한 후, Unity 내에서 객체를 배치합니다.

## WebCam을 이용한 비디오 캡처
OpenCV의 `VideoCapture`를 사용하면 WebGL 환경에서 동작하지 않습니다. 따라서 Unity에서 지원하는 `WebCam`을 이용하여 비디오 캡처를 수행합니다.

## Homography를 통한 월드 좌표 계산
마커 이미지 좌표를 카메라 이미지 좌표로 변환하기 위해 [Homography](../Homography/Homography.md)를 찾습니다. 이를 기반으로 마커 이미지를 월드 좌표로 변환하는 변환 행렬을 구합니다.

1. 마커 이미지 좌표에서 카메라 이미지 좌표로의 변환:

   $$P_2 = H P_1$$

2. 카메라 내부 및 외부 행렬을 이용한 변환:

   $$P_2 = K_2 M K_1^{-1} P_1$$

3. 양변에 \( K_2^{-1} \)를 곱하여 정리:

   $$K_2^{-1} P_2 = M K_1^{-1} P_1$$

4. 월드 좌표 \( P_w \) 계산:

   $$P_w = M K_1^{-1} P_1$$

<br>

Unity에서는 캔버스의 이미지 평면 거리에 맞춰 캔버스 크기를 조절합니다. 이를 위해 월드 좌표에 이미지 평면의 스케일 $S_c$를 적용합니다.

5. 스케일이 적용된 월드 좌표:

   $$P_c = P_w S_c$$

## OpenCV 좌표를 Unity 좌표로 변환
OpenCV의 좌표계를 Unity의 좌표계로 변환합니다.

$$
\begin{align*}
x_{Unity} &= x_{OpenCV} \\
y_{Unity} &= -y_{OpenCV} \\
z_{Unity} &= z_{OpenCV}
\end{align*}
$$

## 이미지 크기에 따른 거리 조절
도형의 닮음을 이용하여 이미지 크기가 일치하도록 이미지 평면의 거리를 계산합니다. 이는 마커의 실제 크기와 화면에 표시되는 크기를 동일하게 맞추기 위함입니다.

## 이미지 크기에 따른 거리 조절
이미지 트래킹 과정에서 마커의 실제 크기와 카메라로 측정된 크기가 일치하지 않을 수 있습니다. 이를 보정하기 위해 각 측정된 길이와 실제 길이의 비율을 이용하여 스케일링 팩터를 계산하고, 길이를 실제 길이로 조정합니다.

### 스케일링 팩터 계산 함수
아래는 C#으로 작성된 함수로, 측정된 길이 배열 `measuredLengths`와 실제 길이 배열 `actualLengths`를 입력으로 받아 스케일링 팩터를 계산한 후, 측정된 길이를 실제 길이로 변환합니다.

위 함수는 다음과 같은 순서로 작동합니다:

1. **비율 계산**: 각 측정된 길이와 실제 길이의 비율을 구합니다.
   $$
   \text{Ratio}_i = \frac{\text{ActualLength}_i}{\text{MeasuredLength}_i}
   $$

2. **평균 비율 계산**: 모든 비율의 합을 계산한 후, 측정된 길이의 개수로 나누어 평균 비율을 구합니다.
   $$
   \text{AverageRatio} = \frac{\sum_{i=1}^{n} \text{Ratio}_i}{n}
   $$

3. **길이 조정**: 측정된 길이에 평균 비율을 곱하여 실제 길이로 변환합니다.
   $$
   \text{AdjustedLength}_i = \text{MeasuredLength}_i \times \text{AverageRatio}
   $$

이렇게 계산된 스케일링 팩터를 이용하면 측정된 길이들을 실제 길이에 맞게 조정할 수 있습니다. 이는 마커의 크기를 정확하게 반영하여 이미지 트래킹의 정확도를 높이는 데 도움이 됩니다.

## 이미지 트래킹 구현
위의 과정을 통해 이미지 트래킹을 구현합니다. 마커를 인식하고 Homography를 이용하여 정확한 위치와 방향을 계산한 후, Unity 내에서 객체를 배치합니다.